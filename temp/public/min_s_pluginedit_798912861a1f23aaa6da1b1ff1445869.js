(function($){window.popupPluginForm=function(area_id,type,index,pageName,pluginArgs,bodyContent,edit_icon,selectedMod){var $textArea=$("#"+area_id);if($textArea.length&&$textArea[0].createTextRange){storeTASelection(area_id)}
var container=$('<div class="plugin"></div>');if(!index){index=0}
if(!pageName&&jqueryTiki.current_object&&jqueryTiki.current_object.type==="wiki page"){pageName=jqueryTiki.current_object.object}
var textarea=$textArea[0];var replaceText=!1;if(!pluginArgs&&!bodyContent){pluginArgs={};bodyContent="";dialogSelectElement(area_id,'{'+type.toUpperCase(),'{'+type.toUpperCase()+'}');var sel=getTASelection(textarea);if(sel&&sel.length>0){sel=sel.replace(/^\s\s*/,"").replace(/\s\s*$/g,"");if(sel.length>0&&sel.substring(0,1)==='{'){var l=type.length,thisType=sel.match(/\{(\w+)/);thisType=thisType[1].toUpperCase();if(thisType===type.toUpperCase()){var rx=new RegExp("{"+type+"[\\(]?([\\s\\S^\\)]*?)[\\)]?}([\\s\\S]*){"+type+"}","mi");var m=sel.match(rx);if(!m){rx=new RegExp("{"+type+"[\\(]?([\\s\\S^\\)]*?)[\\)]?}([\\s\\S]*)","mi");m=sel.match(rx)}
if(m){var paramStr=m[1];bodyContent=m[2];var pm=paramStr.match(/([^=]*)=\"([^\"]*)\"\s?/gi);if(pm){for(var i=0;i<pm.length;i++){var ar=pm[i].split("=");if(ar.length){pluginArgs[ar[0].replace(/^[,\s\"\(\)]*/g,"")]=ar[1].replace(/^[,\s\"\(\)]*/g,"").replace(/[,\s\"\(\)]*$/g,"")}}}}
replaceText=sel}else if(confirm("Click OK to include the "+thisType+" plugin inside a "+type.toUpperCase()+" plugin. Click Cancel to edit the "+thisType+" plugin.")){bodyContent=sel;replaceText=!0}else{window.popupPluginForm(area_id,thisType,index,pageName,null,"",edit_icon,selectedMod);return}}else{if(type==='mouseover'){bodyContent='';pluginArgs={};pluginArgs.label=sel}else{bodyContent=sel}
replaceText=!0}}else{replaceText=!1}}
var $modal;if(selectedMod){$modal=$('body > .modal.fade.show').first()}else{$modal=$('body > .modal.fade:not(.show)').first()}
var url=$.service("plugin","edit",{area_id:area_id,type:type,index:index,page:pageName,pluginArgs:pluginArgs,bodyContent:bodyContent,edit_icon:!!edit_icon,selectedMod:selectedMod?selectedMod:"",modal:1});var prepareModal=function(){if($modal.is(":visible")&&!selectedMod){return}
handlePluginFieldsHierarchy();handleFormSubmit($modal,type,edit_icon,area_id,replaceText);$document.trigger({type:'plugin_'+type+'_ready',container:container,arguments:arguments,modal:$modal}).trigger({type:'plugin_ready',container:container,arguments:arguments,modal:$modal});if($modal.is(":visible")){return}
$('.modal-dialog').addClass("modal-lg");$modal.modal("show");if($("form",this).length&&edit_icon){$modal.one("hidden.bs.modal",function(){$.getJSON($.service("semaphore","unset"),{object_id:pageName})})}};$modal.one("tiki.modal.redraw",function(){prepareModal()}).find(".modal-content").load(url,function(){if($modal.is(":visible")){$(this).trigger("tiki.modal.redraw")}else{$(this).modal("show")}})};function handlePluginFieldsHierarchy(){var $container=$('#plugin_params');var parents={};$("[data-parent_name]",$container).each(function(){var parentName=$(this).data("parent_name"),parentValue=$(this).data("parent_value");if(parentName){var $parent=$('[name$="params['+parentName+']"]',$container);var $row=$(this).parents(".form-group");$row.addClass('parent_'+parentName+'_'+parentValue);if($parent.val()!==parentValue){if(!$parent.val()&&$("input, select",$row).val()){$parent.val(parentValue)}else{$row.hide()}}
if(!parents[parentName]){parents[parentName]={children:[],parentElement:$parent}}
parents[parentName].children.push($(this).attr("id"))}});$.each(parents,function(parentName,parent){parent.parentElement.change(function(){$.each(parent.children,function(index,id){$container.find('#'+id).parents(".form-group").hide()});$container.find('.parent_'+parentName+'_'+this.value).show()}).change().trigger("chosen:updated")})}
function handleFormSubmit(container,type,edit_icon,area_id,replaceText){var params=[],viewPageMode=!!edit_icon,bodyContent="";var $form=$("form",container);$form.submit(function(){if(typeof process_submit==="function"&&!process_submit(this)){return!1}
if(type==="list"&&!viewPageMode&&typeof jqueryTiki.plugins.list.saveToTextarea==="function"){jqueryTiki.plugins.list.saveToTextarea()}
$("[name^=params]",$form).each(function(){var name=$(this).attr("name"),matches=name.match(/params\[(.*)\]/),val=$(this).val();if(!matches){if(name==="content"){bodyContent=$(this).val()}
return}
if(val&&!viewPageMode){val=val.replace(/"/g,'\\"');params.push(matches[1]+'="'+val+'"')}});var blob,pluginContentTextarea=$("[name=content]",$form),pluginContentTextareaEditor=syntaxHighlighter.get(pluginContentTextarea);if(!viewPageMode){if(!bodyContent){bodyContent=(pluginContentTextareaEditor?pluginContentTextareaEditor.getValue():pluginContentTextarea.val())}
if(bodyContent){blob='{'+type.toUpperCase()+'('+params.join(' ')+')}'+bodyContent+'{'+type.toUpperCase()+'}'}else{blob='{'+type.toLowerCase()+(params.length?' ':'')+params.join(' ')+'}'}
insertAt(area_id,blob,!1,!1,replaceText);$form.parents(".modal").modal("hide");return!1}
return!0})}})(jQuery)